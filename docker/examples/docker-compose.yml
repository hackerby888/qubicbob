# Docker Compose for qubic-bob with external KeyDB and Kvrocks
# Image: j0et0m/qubic-bob:prod

services:
  qubic-bob:
    image: j0et0m/qubic-bob:prod
    container_name: qubic-bob
    restart: unless-stopped
    ports:
      - "21842:21842"
      - "40420:40420"
    volumes:
      - ./bob.json:/app/config/bob.json:ro
      - qubic-bob-data:/data/bob
    depends_on:
      keydb:
        condition: service_healthy
      kvrocks:
        condition: service_healthy
    networks:
      - qubic-bob-network

  keydb:
    image: eqalpha/keydb:latest
    container_name: qubic-bob-keydb
    restart: unless-stopped
    command: keydb-server /etc/keydb/keydb.conf
    volumes:
      - qubic-bob-keydb-data:/data
      - ./keydb.conf:/etc/keydb/keydb.conf:ro
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "keydb-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - qubic-bob-network

  kvrocks:
    image: apache/kvrocks:latest
    container_name: qubic-bob-kvrocks
    restart: unless-stopped
    command: kvrocks -c /var/lib/kvrocks/kvrocks.conf
    volumes:
      - qubic-bob-kvrocks-data:/var/lib/kvrocks
      - ./kvrocks.conf:/var/lib/kvrocks/kvrocks.conf:ro
    ports:
      - "6666:6666"
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "6666", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - qubic-bob-network

volumes:
  qubic-bob-keydb-data:
    driver: local
  qubic-bob-kvrocks-data:
    driver: local
  qubic-bob-data:
    driver: local

networks:
  qubic-bob-network:
    driver: bridge
